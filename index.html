<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMAIL SHOP ü©≥</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            background-image: linear-gradient(135deg, #16222a 0%, #3a6073 100%);
            background-attachment: fixed;
        }
        .main-container {
            max-width: 420px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }
        .text-gradient {
            background: linear-gradient(to right, #79c2ff, #d8b4fe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .btn-premium {
            background-image: linear-gradient(to right, #6a82fb 0%, #fc5c7d 100%);
            color: #ffffff;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            padding: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .btn-premium:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            transform: translateY(-2px);
        }
        .btn-premium:active {
            transform: translateY(0px) scale(0.98);
        }
        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.1);
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-weight: 500;
            border-radius: 12px;
            padding: 14px;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: rgba(255, 255, 255, 0.15);
        }
        .input-field {
            background-color: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 14px;
            color: #ffffff;
            transition: all 0.2s ease;
        }
        .input-field::placeholder {
            color: #8a8a9e;
        }
        .input-field:focus {
            outline: none;
            border-color: #79c2ff;
            box-shadow: 0 0 0 3px rgba(121, 194, 255, 0.3);
        }
        .page { display: none; }
        .page.active { display: flex; flex-direction: column; flex-grow: 1; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* Loader Styles */
        #loader {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        #loader .spinner {
            width: 56px;
            height: 56px;
            border: 6px solid rgba(255, 255, 255, 0.2);
            border-top-color: #79c2ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loader" class="hidden fixed inset-0 flex items-center justify-center z-50">
        <div class="spinner"></div>
    </div>

    <div class="main-container">
        <div id="auth-page" class="page p-6 justify-center">
            <div class="glass-card p-8 w-full">
                <div class="text-center mb-8">
                    <h1 class="text-4xl font-extrabold text-gradient">GMAIL SHOP</h1>
                    <p class="text-gray-400 mt-2">Welcome Back</p>
                </div>
                <div>
                    <input id="login-email" type="email" placeholder="Email" class="w-full p-3 rounded-lg input-field mb-4">
                    <input id="login-password" type="password" placeholder="Password" class="w-full p-3 rounded-lg input-field mb-4">
                    <button id="login-btn" class="w-full p-3 rounded-lg btn-premium">Secure Login</button>
                </div>
            </div>
        </div>

        <div id="app-page" class="page">
            <header class="p-6 flex items-center justify-between">
                <h1 class="text-2xl font-bold text-gradient">Dashboard</h1>
                <div class="text-right">
                    <p class="text-sm text-gray-400">Balance</p>
                    <p id="header-balance-display" class="font-bold text-lg">‡ß≥0.00</p>
                </div>
            </header>

            <main class="flex-grow p-6 space-y-6">
                <div class="glass-card p-6 text-center">
                     <p class="text-gray-300 mb-4">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç ‡¶â‡¶®‡ßç‡¶®‡¶§ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ‡ßá ‡¶Ø‡ßã‡¶ó ‡¶¶‡¶ø‡¶®‡•§</p>
                     <a href="https://t.me/your_new_bot_link" target="_blank" class="btn-premium w-full flex items-center justify-center gap-2">
                         <i data-lucide="send"></i>
                         <span>‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ü</span>
                     </a>
                </div>
                
                <div class="glass-card p-6 text-center">
                    <p class="text-gray-300 mb-4">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ü‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                    <button id="withdraw-btn" class="btn-secondary w-full flex items-center justify-center gap-2">
                        <i data-lucide="arrow-down-square"></i>
                        <span>‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®</span>
                    </button>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-xl font-semibold mb-4 text-center">Withdrawal History</h3>
                    <div id="withdraw-history-list" class="space-y-3">
                        <p class="text-gray-400 text-center">No withdrawal history found.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="glass-card p-6 w-full max-w-sm text-center">
            <p id="alert-message" class="mb-6 whitespace-pre-wrap"></p>
            <button id="alert-ok-btn" class="btn-premium px-10 py-2">OK</button>
        </div>
    </div>

    <script type="module">
        // Firebase and other necessary imports would go here.
        // For demonstration, the Firebase logic is included below.
        
        const firebaseConfig = {
            apiKey: "AIzaSyBP3OLSykSzQFEEQLDkDO7_rVg-PkY81C0",
            authDomain: "mail-shop-e2256.firebaseapp.com",
            projectId: "mail-shop-e2256",
            storageBucket: "mail-shop-e2256.firebasestorage.app",
            messagingSenderId: "985793375010",
            appId: "1:985793375010:web:2a9afc1aeec74168d2137b"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        
        const loader = document.getElementById('loader');
        
        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            showPage('auth-page');
            onAuthStateChanged(auth, handleAuthStateChange);
        };

        async function handleAuthStateChange(user) {
            toggleLoader(true);
            if (user) {
                currentUser = user;
                await fetchUserData();
                if (userData.isBlocked) {
                    showAlert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§");
                    await signOut(auth);
                    toggleLoader(false);
                    return;
                }
                updateUI();
                showPage('app-page');
                loadWithdrawalHistory();
            } else {
                currentUser = null;
                userData = null;
                showPage('auth-page');
            }
            toggleLoader(false);
        }

        async function fetchUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                userData = userSnap.data();
            } else {
                // Handle case where user exists in Auth but not Firestore
                await signOut(auth);
            }
        }
        
        function updateUI() {
            if (!userData) return;
            const balance = (userData.balance || 0).toFixed(2);
            document.getElementById('header-balance-display').textContent = `‡ß≥${balance}`;
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('withdraw-btn').addEventListener('click', handleFullWithdraw);
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            if (!email || !password) return showAlert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶á‡¶Æ‡ßá‡¶á‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶æ‡¶∏‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶° ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®‡•§");
            toggleLoader(true);
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                showAlert("‡¶≤‡¶ó‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                console.error(error);
            } finally {
                toggleLoader(false);
            }
        }
        
        async function handleFullWithdraw() {
            const balance = userData.balance || 0;
            if (balance <= 0) {
                return showAlert("‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü‡ßá ‡¶ï‡ßã‡¶®‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶®‡ßá‡¶á‡•§");
            }
            
            const confirmation = confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡ß≥${balance.toFixed(2)} ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ü‡ßá ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡ßü‡¶æ‡¶ü‡¶ø ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶® ‡¶π‡¶≤‡ßá ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶∂‡ßÇ‡¶®‡ßç‡¶Ø ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`);

            if (!confirmation) {
                return;
            }

            toggleLoader(true);
            try {
                // Request withdrawal for the full balance
                await addDoc(collection(db, "withdrawals"), {
                    userId: currentUser.uid,
                    userName: userData.name,
                    userChatId: userData.chatId || 'Not Provided', // Assuming you have chatId in user data
                    amount: balance,
                    method: "Balance Transfer to New Bot",
                    recipientNumber: "Internal Transfer",
                    status: "pending", 
                    requestedAt: serverTimestamp()
                });
                
                // Set user's current balance to 0
                const userRef = doc(db, "users", currentUser.uid);
                await setDoc(userRef, { balance: 0 }, { merge: true });
                
                // Update local data and UI
                userData.balance = 0;
                updateUI();
                
                showAlert(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡ß≥${balance.toFixed(2)} ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶ú‡¶Æ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶°‡¶Æ‡¶ø‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶≤‡ßã‡¶ö‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶§‡ßÅ‡¶® ‡¶¨‡¶ü‡ßá ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶Ø‡ßã‡¶ó ‡¶π‡ßü‡ßá ‡¶Ø‡¶æ‡¶¨‡ßá‡•§`);
                loadWithdrawalHistory();
            } catch (error) {
                console.error("Error during full withdrawal:", error);
                showAlert("‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶∏‡ßç‡¶•‡¶æ‡¶®‡¶æ‡¶®‡ßç‡¶§‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
            } finally {
                toggleLoader(false);
            }
        }

        async function loadWithdrawalHistory() {
            const historyList = document.getElementById('withdraw-history-list');
            historyList.innerHTML = '<p class="text-gray-400 text-center">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>';
            try {
                const q = query(collection(db, "withdrawals"), where("userId", "==", currentUser.uid), orderBy("requestedAt", "desc"));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    historyList.innerHTML = '<p class="text-gray-400 text-center">‡¶è‡¶ñ‡¶®‡ßã ‡¶ï‡ßã‡¶®‡ßã ‡¶≤‡ßá‡¶®‡¶¶‡ßá‡¶® ‡¶π‡ßü‡¶®‡¶ø‡•§</p>';
                    return;
                }

                historyList.innerHTML = snapshot.docs.map(docSnap => {
                    const item = docSnap.data();
                    let statusColor, statusIcon, statusText;
                    switch (item.status) {
                        case 'approved':
                            statusColor = 'text-green-400';
                            statusIcon = 'check-circle-2';
                            statusText = 'Approved';
                            break;
                        case 'rejected':
                            statusColor = 'text-red-400';
                            statusIcon = 'x-circle';
                            statusText = 'Rejected';
                            break;
                        default:
                            statusColor = 'text-yellow-400';
                            statusIcon = 'hourglass';
                            statusText = 'Pending';
                    }
                    const date = item.requestedAt ? item.requestedAt.toDate().toLocaleDateString('en-GB') : 'N/A';
                    const method = item.method === "Balance Transfer to New Bot" ? "Balance Transfer" : item.method;
                    
                    return `
                    <div class="glass-card p-4 flex items-center justify-between text-sm">
                        <div class="flex items-center gap-3">
                            <i data-lucide="${statusIcon}" class="w-5 h-5 ${statusColor}"></i>
                            <div>
                                <p class="font-semibold">${method}</p>
                                <p class="text-xs text-gray-400">${date}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-base">‡ß≥${item.amount.toFixed(2)}</p>
                            <p class="font-semibold ${statusColor} capitalize text-xs">${statusText}</p>
                        </div>
                    </div>`;
                }).join('');
                lucide.createIcons();
            } catch (error) {
                historyList.innerHTML = '<p class="text-red-400 text-center">‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡¶ø ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§</p>';
                console.error("Error loading withdrawal history:", error);
            }
        }

        function toggleLoader(show) {
            const loader = document.getElementById('loader');
            if (show) {
                loader.classList.remove('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function showAlert(message) {
            document.getElementById('alert-message').innerText = message;
            document.getElementById('custom-alert').classList.remove('hidden');
            document.getElementById('alert-ok-btn').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
        }

    </script>
</body>
</html>
